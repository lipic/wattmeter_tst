function updateData(){$.ajax({url:"/updateData"}).done((function(e){$("#updateData").html(e.datalayer),$("#WATTMETER_TIME").text(e.WATTMETER_TIME);var t=parseInt(e.RUN_TIME,10);t-=3600*(s=Math.floor(t/86400))*24;var a=Math.floor(t/3600);t-=3600*a;var r=Math.floor(t/60);t-=60*r,$("#RUN_TIME").text((s<10?"0"+s:s)+":"+(a<10?"0"+a:a)+":"+(r<10?"0"+r:r)+":"+(t<10?"0"+t:t));var n=e.U1,o=e.U2,d=e.U3;$("#U1").text(n),$("#U2").text(o),$("#U3").text(d);var i=((e.I1>32767?e.I1-65535:e.I1)/100).toFixed(2),l=((e.I2>32767?e.I2-65535:e.I2)/100).toFixed(2),s=((e.I3>32767?e.I3-65535:e.I3)/100).toFixed(2);$("#I1").text(i),$("#I2").text(l),$("#I3").text(s);var u=((e.P1>32767?e.P1-65535:e.P1)/1e3).toFixed(2),g=((e.P2>32767?e.P2-65535:e.P2)/1e3).toFixed(2),c=((e.P3>32767?e.P3-65535:e.P3)/1e3).toFixed(2);$("#P1").text(u),$("#P2").text(g),$("#P3").text(c),((e.P1>32767?e.P1-65535:e.P1)/1e3).toFixed(2),((e.P2>32767?e.P2-65535:e.P2)/1e3).toFixed(2),((e.P3>32767?e.P3-65535:e.P3)/1e3).toFixed(2),e.AC_IN>0?($("#AC_IN").text("ON"),$("#AC_IN").css("color","#74DF00")):($("#AC_IN").text("OFF"),$("#AC_IN").css("color","#FF0000")),e.RELAY>0?($("#RELAY").text("ON"),$("#RELAY").css("color","#74DF00")):($("#RELAY").text("OFF"),$("#RELAY").css("color","#FF0000")),$("#PF1").text((e.PF1/100).toFixed(2)),$("#PF2").text((e.PF2/100).toFixed(2)),$("#PF3").text((e.PF3/100).toFixed(2)),$("#PP1p").text((e.PP1p/1e3).toFixed(1)),$("#PP2p").text((e.PP2p/1e3).toFixed(1)),$("#PP3p").text((e.PP3p/1e3).toFixed(1)),$("#PN1p").text((e.PN1p/1e3).toFixed(1)),$("#PN2p").text((e.PN2p/1e3).toFixed(1)),$("#PN3p").text((e.PN3p/1e3).toFixed(1)),$("#E1dP").text((e.E1dP/100).toFixed(2)),$("#E2dP").text((e.E2dP/100).toFixed(2)),$("#E3dP").text((e.E3dP/100).toFixed(2)),$("#E1dN").text((e.E1dN/100).toFixed(2)),$("#E2dN").text((e.E2dN/100).toFixed(2)),$("#E3dN").text((e.E3dN/100).toFixed(2)),e.E1tP/100>1e6||e.E2tP/100>1e6||e.E3tP/100>1e6?($("#E1tP").text((e.E1tP/1e8).toFixed(2)),$("#E2tP").text((e.E2tP/1e8).toFixed(2)),$("#E3tP").text((e.E3tP/1e8).toFixed(2),$("#EtP").text("↑ Total E [GWh]"))):e.E1tP/100>1e3||e.E2tP/100>1e3||e.E3tP/100>1e3?($("#E1tP").text((e.E1tP/1e5).toFixed(2)),$("#E2tP").text((e.E2tP/1e5).toFixed(2)),$("#E3tP").text((e.E3tP/1e5).toFixed(2),$("#EtP").text("↑ Total E [MWh]"))):($("#E1tP").text((e.E1tP/100).toFixed(1)),$("#E2tP").text((e.E2tP/100).toFixed(1)),$("#E3tP").text((e.E3tP/100).toFixed(1),$("#EtP").text("↑ Total E [kWh]"))),e.E1tN/100>1e6||e.E2tN/100>1e6||e.E3tN/100>1e6?($("#E1tN").text((e.E1tP/1e8).toFixed(2)),$("#E2tN").text((e.E2tN/1e8).toFixed(2)),$("#E3tN").text((e.E3tN/1e8).toFixed(2),$("#EtN").text("↑ Total E [GWh]"))):e.E1tN/100>1e3||e.E2tN/100>1e3||e.E3tN/100>1e3?($("#E1tN").text((e.E1tN/1e5).toFixed(2)),$("#E2tN").text((e.E2tN/1e5).toFixed(2)),$("#E3tN").text((e.E3tN/1e5).toFixed(2),$("#EtN").text("↑ Total E [MWh]"))):($("#E1tN").text((e.E1tN/100).toFixed(1)),$("#E2tN").text((e.E2tN/100).toFixed(1)),$("#E3tN").text((e.E3tN/100).toFixed(1),$("#EtN").text("↑ Total E [kWh]"))),$("#Current_EP").text(((e.E1dP+e.E2dP+e.E3dP)/100).toFixed(2)),$("#Current_EN").text(((e.E1dN+e.E2dN+e.E3dN)/100).toFixed(2)),$("#Previous_EP").text((e.EpDP/100).toFixed(2)),$("#Previous_EN").text((e.EpDN/100).toFixed(2)),$("#Total_EP").text(((e.E1tP+e.E2tP+e.E3tP)/100).toFixed(0)),$("#Total_EN").text(((e.E1tN+e.E2tN+e.E3tN)/100).toFixed(0)),$("#ID").text(e.ID),hourEnergyData=e.E_hour,dailyEnergyData=e.DailyEnergy,powerAVGchartData=e.P_minuten,dotControl()}))}function chargingAnim(e,t){for(var a=1;a<5;a++)$(".charge"+(a+4*(t-1))).css("animation-play-state",e)}function handleEvseAPI(e,t,a,r){for(var n=1;n<=e;n++)$("#ACTUAL_CONFIG_CURRENT"+n).text(0==isNaN(t[n-1])?t[n-1]+" A":"COMM ERR."),$("#ACTUAL_OUTPUT_CURRENT"+n).text(0==isNaN(a[n-1])?a[n-1]+" A":"COMM ERR."),r[n-1]<1||r[n-1]>3||1==isNaN(r[n-1])?($("#EV_STATE"+n).text("COMM ERR."),chargingAnim("paused",n),$(".charge"+(1+4*(n-1))).css("background-color","black"),$(".charge"+(2+4*(n-1))).css("background-color","black"),$(".charge"+(3+4*(n-1))).css("background-color","black"),$(".charge"+(4+4*(n-1))).css("background-color","black")):1==r[n-1]?($("#EV_STATE"+n).text("UNPLUG"),chargingAnim("paused",n),$(".charge"+(1+4*(n-1))).css("background-color","red"),$(".charge"+(2+4*(n-1))).css("background-color","red"),$(".charge"+(3+4*(n-1))).css("background-color","red"),$(".charge"+(4+4*(n-1))).css("background-color","red")):2==r[n-1]?($("#EV_STATE"+n).text("PLUG"),chargingAnim("paused",n),$(".charge"+(1+4*(n-1))).css("background-color","yellow"),$(".charge"+(2+4*(n-1))).css("background-color","yellow"),$(".charge"+(3+4*(n-1))).css("background-color","yellow"),$(".charge"+(4+4*(n-1))).css({"background-color":"yellow"})):3==r[n-1]&&($("#EV_STATE"+n).text("CHARGING"),chargingAnim("running",n),$(".charge"+(1+4*(n-1))).css("background-color","green"),$(".charge"+(2+4*(n-1))).css("background-color","green"),$(".charge"+(3+4*(n-1))).css("background-color","green"),$(".charge"+(4+4*(n-1))).css("background-color","green"))}function dotControl(){elements=$(".dot");for(var e=0;e<elements.length;e++)"red"==elements[e].style.backgroundColor?elements[e].style.backgroundColor="":elements[e].style.backgroundColor="red"}function getTime(){var e=new Date,t=""+(e.getMonth()+1);return[""+e.getDate(),t,e.getFullYear(),e.getHours(),e.getMinutes(),e.getSeconds()]}function loadPowerChart(){len=powerAVGchartData[0];for(var e=1;e<61-len;e++)powerGraph.config.data.datasets.forEach((function(t){t.data.push({x:Date.now()-1e3*(61-e)*60,y:0})}));for(e=1;e<len;e++){var t;t=null!=powerAVGchartData[e]?powerAVGchartData[e]:0,powerGraph.config.data.datasets.forEach((function(a){a.data.push({x:Date.now()-1e3*(len-e)*60,y:t})}))}powerGraph.update()}function refreshPowerChart(){len=powerAVGchartData[0],powerGraph.config.data.datasets.forEach((function(e){e.data.push({x:Date.now(),y:powerAVGchartData[len-1]})}))}function refreshEnergyChartHourly(){len=hourEnergyData[0];for(var e=0,t=0,a=0,r=0,n=0;n<24;n++)null!=hourEnergyData[4*n+4]?(e=hourEnergyData[4*n+1],dataP=hourEnergyData[4*n+2],dataN=hourEnergyData[4*n+3],a=a+dataP-dataN,r+=1,energyGraphHourly.data.labels[24-((len-1)/4-n)]=e+1<10?"0"+e+"-0"+(e+1):e+1==10?"09-10":e+"-"+(e+1),energyGraphHourly.data.datasets[0].data[24-((len-1)/4-n)]=dataP,1==hourEnergyData[4*n+4]?energyGraphHourly.data.datasets[0].backgroundColor[24-((len-1)/4-n)]="rgb(114, 189, 0)":energyGraphHourly.data.datasets[0].backgroundColor[24-((len-1)/4-n)]="rgb(0, 191, 235)",energyGraphHourly.data.datasets[1].data[24-((len-1)/4-n)]=-dataN):(e<23?(e+=1,energyGraphHourly.data.labels[t]=e+1<10?"0"+e+"-0"+(e+1):e+1==10?"09-10":e+"-"+(e+1),energyGraphHourly.data.datasets[0].data[t]=0,energyGraphHourly.data.datasets[1].data[t]=0,t++):(e=0,energyGraphHourly.data.labels[t]="0"+e+"-0"+(e+1),energyGraphHourly.data.datasets[0].data[t]=0,energyGraphHourly.data.datasets[1].data[t]=0,t++),t>23&&(t=0));for(var o=0;o<24;o++)energyGraphHourly.data.datasets[2].data[o]=(a/r).toFixed(1);energyGraphHourly.update()}function refreshEnergyChartDaily(){var e=0,t=1;null!=dailyEnergyData&&(t=dailyEnergyData.length-1),days=Last31Days();for(var a=0;a<31;a++)null!=dailyEnergyData&&null!=dailyEnergyData[t-a]?(arr=dailyEnergyData[t-a].split(":"),e=arr[0],dat=JSON.parse(arr[1]),dataP=dat[0],dataN=dat[1],energyGraphDaily.data.labels[30-a]=e,energyGraphDaily.data.datasets[0].data[30-a]=parseFloat(dataP/100).toFixed(1),energyGraphDaily.data.datasets[1].data[30-a]=-parseFloat(dataN/100).toFixed(1)):(energyGraphDaily.data.labels[30-a]=days[a],energyGraphDaily.data.datasets[0].data[30-a]=0,energyGraphDaily.data.datasets[1].data[30-a]=0);for(var r=0;r<31;r++)energyGraphDaily.data.datasets[2].data[r]=getAvgEnergy();energyGraphDaily.update()}function getAvgEnergy(){for(var e=0,t=0,a=0;a<31;a++)null!=dailyEnergyData&&null!=dailyEnergyData[a]&&(arr=dailyEnergyData[a].split(":"),dat=JSON.parse(arr[1]),dataP=dat[0],dataN=dat[1],e=e+parseFloat(dataP/100)-parseFloat(dataN/100),t++);return(e/t).toFixed(1)}function Last31Days(){for(var e=[],t=1;t<32;t++){var a=new Date;a.setDate(a.getDate()-t),e.push(formatDate(a))}return e}function formatDate(e){var t=e.getDate(),a=e.getMonth()+1;return t<10&&(t="0"+t),a<10&&(a="0"+a),(a+"/"+t+"/"+e.getFullYear().toString().substr(-2)).toString()}function openNav(){$("#mySidenav").css("width","250px")}function closeNav(){$("#mySidenav").css("width","0")}function updateOverView(e,t){$("#updateData").html(e.datalayer),"undefined"==evseInstanceGauge&&0!=e.NUMBER_OF_EVSE&&(evseInstanceGauge=new evse(e.NUMBER_OF_EVSE),evseInstanceGauge.createEvseGauge());var a=(((e.P1>32767?e.P1-65535:e.P1)+(e.P2>32767?e.P2-65535:e.P2)+(e.P3>32767?e.P3-65535:e.P3))/1e3).toFixed(1);t.set((a>20?20:a)<0?-1*(a>20?20:a):a>20?20:a),$("#powerTxt").text(a.toString()),powerAVGchartData=e.P_minuten,hourEnergyData=e.E_hour,dailyEnergyData=e.DailyEnergy;for(var r=((e.E1tP+e.E2tP+e.E3tP)/100).toFixed(0).toString(),n=((e.E1dP+e.E2dP+e.E3dP)/100).toFixed(1).toString(),o=(e.EpDP/100).toFixed(1).toString(),d=r.length-1;d>=0;d--)$("#kWh"+(r.length-d)).text(r[d]),$("#dWh"+(n.length-d)).text(n[d]),$("#lWh"+(o.length-d)).text(o[d]);handleEvseAPI(e.NUMBER_OF_EVSE,e.ACTUAL_CONFIG_CURRENT,e.ACTUAL_OUTPUT_CURRENT,e.EV_STATE),dotControl()}powerAVGchartData=0,hourEnergyData=[],dailyEnergyData=[],powerGraph="undefined",energyGraphHourly="undefined",evseInstanceGauge="undefined",timer=0,refreshGraphs=0,$((function(){$("div.mainContainer").load("overview",(function(){$(".loader").hide(100);var e=new GaugeSetting("power",20,0).getGauge();$("#powerTxt").text("0.0"),$.ajax({url:"/updateData"}).done((function(t){updateOverView(t,e)})),timer=setInterval((function(){$.ajax({url:"/updateData"}).done((function(t){updateOverView(t,e)}))}),2e3)})),$("#mySidenav a").click((function(e){"overview"==$(this).attr("id")?(clearTimeout(timer),evseInstanceGauge="undefined",$("div.mainContainer").load("overview",(function(){$("#sideText").text("☰ Overview");var e=new GaugeSetting("power",20,0).getGauge();$("#powerTxt").text("0.0"),$.ajax({url:"/updateData"}).done((function(t){updateOverView(t,e)})),timer=setInterval((function(){$.ajax({url:"/updateData"}).done((function(t){updateOverView(t,e)}))}),2e3)}))):"data"==$(this).attr("id")?(clearTimeout(timer),$("div.mainContainer").load("datatable",(function(){evseInstanceGauge="undefined",$("#sideText").text("☰ Data"),updateData(),timer=setInterval((function(){updateData()}),2e3)}))):"settings"==$(this).attr("id")?(clearTimeout(timer),$("div.mainContainer").load("settings",(function(){var e=new Setting;e.refreshSetting(),e.refreshWifiClient(),evseInstanceGauge="undefined",$("#sideText").text("☰  Settings"),$("#refreshSSID").append('<span class="spinner-border spinner-border-sm"></span>')}))):"powerChart"==$(this).attr("id")?(clearTimeout(timer),$("div.mainContainer").load("powerChart",(function(){evseInstanceGauge="undefined","undefined"!=powerGraph&&powerGraph.destroy(),$("#sideText").text("☰  Power chart");var e=new powerChart(refreshPowerChart),t=$("#powerGraph"),a=e.getConfig();powerGraph=new Chart(t,a),timer=setInterval((function(){$.ajax({url:"/updateData"}).done((function(e){$("#updateData").html(e.datalayer),powerAVGchartData=e.P_minuten,dotControl()}))}),5e3),loadPowerChart()}))):"energyChart"==$(this).attr("id")&&(clearTimeout(timer),$("div.mainContainer").load("energyChart",(function(){evseInstanceGauge="undefined","undefined"!=energyGraphHourly&&(energyGraphHourly.destroy(),energyGraphDaily.destroy()),$("#sideText").text("☰  Energy charts");var e=new energyChart("","Hourly E [Wh]","Wh"),t=new energyChart("","Daily E [kWh]","kWh");d=new energyChart("","Monthly E [kWh]","kWh"),o=$("#energyGraph_hourly"),d=e.getConfig(24),energyGraphHourly=new Chart(o,d);var a=$("#energyGraph_daily"),r=t.getConfig(31);energyGraphDaily=new Chart(a,r),timer=setInterval((function(){$.ajax({url:"/updateData"}).done((function(e){$("#updateData").html(e.datalayer),hourEnergyData=e.E_hour,dailyEnergyData=e.DailyEnergy,refreshEnergyChartHourly(),refreshEnergyChartDaily(),dotControl()}))}),2e4),energyGraphDaily.getDatasetMeta(1).hidden=!0,energyGraphDaily.update(),energyGraphHourly.getDatasetMeta(1).hidden=!0,energyGraphHourly.update(),refreshEnergyChartHourly(),refreshEnergyChartDaily()})))})),$(document).on("click","#synchroTime",(function(){$("#synchroTime").append('<span class="spinner-border spinner-border-sm"></span>'),e=getTime(),e&&$.ajax({type:"POST",url:"/updateData",async:!0,data:JSON.stringify({time:e}),success:function(e){$("#updateData").html(e.datalayer),$("#synchroTime").find("span").remove()}})})),$(document).on("click","#relay",(function(){e=1,e&&$.ajax({type:"POST",url:"/updateData",async:!0,data:JSON.stringify({relay:e}),success:function(e){$("#updateData").html(e.datalayer),1==e.process?($("#RELAY").text("ON"),$("#RELAY").css("color","#74DF00")):($("#RELAY").text("OFF"),$("#RELAY").css("color","#FF0000"))}})}))}));